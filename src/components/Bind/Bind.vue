<template>
    <div class="binding-vehicle">
        <div class="binding-vehicle-cont">
            <div class="b-v-title">填写绑定信息</div>
            <div class="b-v-form">
                <dl flex>
                    <dt>手机号：</dt>
                    <dd>
                        <input type="text" name="" placeholder="请输入您的手机号" maxlength="11" v-model="telphone">
                    </dd>
                </dl>
                <dl flex class="captcha">
                    <dt flex-box="0">验证码：</dt>
                    <dd flex-box="1">
                        <input type="tel" name="" placeholder="请输入您的验证码" maxlength="6" v-model="captchaNum">
                    </dd>
                    <dd flex-box="0">
                        <button @click.stop="captcha" :disabled="captchaLoading">{{captchaBtnTxt}}</button>
                    </dd>
                </dl>
                <dl flex class="car-pai">
                    <dt flex-box="0">车牌号：</dt>
                    <dd flex-box="1" flex>
                        <span class="pai-span">
                            <select v-model="plateCity">
                                <option v-for="item in plateItems" :value="item.value">{{item.text}}</option>
                            </select>
                            <i>{{cityName}}</i>
                        </span>
                        <span>
                            <input type="text" name="" placeholder="请输入您的车牌号" maxlength="6" v-model="plateNum">
                        </span>
                    </dd>
                </dl>
            </div>
            <div flex="main:center" class="btn">
                <button @click.stop="submit">立即绑定</button>
            </div>
        </div>
        <div class="bingding-gou">
            <span class="bingding-gou-left"></span>
            <span class="bingding-gou-right"></span>
        </div>

    </div>
</template>

<script>
    import './bind.less';
    import $api from '../../tools/api';
    import { checkPhone, setTitle } from '../../tools/operation';
    import {Toast, Indicator} from 'mint-ui';
    import cityItems from '../../../city/city.js';
    export default {
        name: 'bind',
        data(){
            return {
                telphone:'',
                captchaNum:'',
                plateNum:'',
                plateCity:'',

                plateItems:[],
                captchaBtnTxt:'发送验证码',
                captchaLoading:false,
                timer:null,
                code:'',
                validCode:'XXXoooo9999'//验证码存储
            }
        },
        created(){
            this.code = this.$route.query.code;
            cityItems.map(item => {
                this.plateItems.push(item);
            });
            this.plateCity = cityItems[0].value;

            this.getUserInfor();
        },
        computed: {
            cityName:function(){
                let text = cityItems[0].value;
                this.plateItems.map(item => {

                    if(item.value == this.plateCity){
                        console.log(item)
                        text = item.text;
                    }
                });
                return text;
            }
        },
        components:{

        },
        methods: {
            getUserInfor(){
                let userInfor = JSON.parse(sessionStorage.getItem('userInfor')) || {};
                this.openId = userInfor.openid || '';
            },
            //发送验证码
            captcha(){
                let { telphone } = this;
                if(!checkPhone(telphone)){
                    Toast('请填写有效的手机号码！');
                    return false;
                }
                if(this.captchaLoading){
                    return false;
                }
                if(this.timer){
                    clearTimeout(this.timer);
                }

                this.sendCode(60);
                $api.get(`/user/code/sendValidCode/${telphone}`,{
                    
                }).then(res => {
                    if(res.code == '01'){
                        this.validCode = res.data;
                        this.clearValidCode();
                    }else{
                        Toast(res.msg);
                    }
                });
            },
            sendCode(time){
                this.captchaLoading = true;
                //time = time || 60;
                this.captchaBtnTxt = `${time}s`;
                if(time > 0){
                    time -- ;
                    this.timer = setTimeout(() => {
                        this.sendCode(time)
                    },1000);
                }else{
                    this.captchaBtnTxt = '重新发送'
                    this.captchaLoading = false;
                }
                
            },
            //绑定
            submit(){
                let {
                    telphone,
                    captchaNum,code,
                    cityName,
                    plateNum,
                    openId
                } = this;
                if(!checkPhone(telphone)){
                    Toast('请填写有效的手机号码！');
                    return false;
                }
                if(!captchaNum.trim()){
                    Toast('请填写验证码！');
                    return false;
                }
                if(!plateNum.trim()){
                    Toast('请填车牌号！');
                    return false;
                }
                plateNum = ''+ cityName + plateNum;
                if(captchaNum != this.validCode){
                    console.log(captchaNum,this.validCode)
                    Toast('验证码输入有误！');
                    return false;
                }
                Indicator.open({
                    spinnerType:'triple-bounce'
                });
                //模拟
                // setTimeout(()=>{
                //     Indicator.close();
                //     this.$router.push({
                //         path:'/nuoche-inform',
                //         query:{
                //             code:this.code
                //         }
                //     })
                // },1000)
                //绑定code
                openId = openId || '""';
                $api.get(`/user/code/bind/${telphone}/${code}/${encodeURI(plateNum)}/${openId}`).then(res => {
                    Indicator.close();

                    if(res.code == '01'){
                        //绑定成功，判断是否关注公众号？
                        $api.get(`/wechat/isBind/${code}`,).then( res =>{
                            if(res.code == '01'){
                                Toast({
                                    message:'您已经成功绑定挪车码！',
                                    duration:2000
                                });
                                setTimeout(()=>{
                                    this.$router.replace({
                                        path:'/my-code'
                                    })
                                },2000);
                                
                            }if(res.code == '02'){
                                //未关注
                                this.$router.replace({
                                    path:'/guan-zhu',
                                    query:{
                                        code
                                    }
                                });

                            }else{
                                Toast(res.msg || '服务器错误');
                            }
                        });
                    }else{
                        Toast(res.msg);
                        return null
                    }
                })
            },
            //清除存储的验证码
            clearValidCode(time){
                if(this.timeOuter){
                    clearTimeout(this.timeOuter);
                }
                this.timeOuter = setTimeout(()=>{
                    this.validCode = 'XXXoooo9999';
                },120000);
            }
        },
        destroyed(){

        }
    }
</script>
